{% extends "layout.html" %}

{% block title %}Network Monitor - SLA Dashboard{% endblock %}

{% block page_title %}SLA Dashboard{% endblock %}

{% set active_page = 'sla' %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="flex-between mb-2">
        <div>
            <p class="text-muted">Service Level Agreement monitoring and uptime statistics</p>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <label style="color: var(--text-muted); font-size: 0.875rem;">Period:</label>
            <select id="sla-period" class="form-input" style="width: auto;" onchange="loadSlaData()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
            <label style="color: var(--text-muted); font-size: 0.875rem; margin-left: 1rem;">Target:</label>
            <select id="sla-target" class="form-input" style="width: auto;" onchange="loadSlaData()">
                <option value="99">99%</option>
                <option value="99.5">99.5%</option>
                <option value="99.9" selected>99.9%</option>
                <option value="99.99">99.99%</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="loadSlaData()">üîÑ Refresh</button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-5 mb-2" id="summary-cards">
        <div class="stat-card">
            <div class="stat-value" id="avg-uptime">-</div>
            <div class="stat-label">Average Uptime</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-devices">0</div>
            <div class="stat-label">Total Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sla-met" style="color: var(--success);">0</div>
            <div class="stat-label">‚úÖ SLA Met</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sla-warning" style="color: var(--warning);">0</div>
            <div class="stat-label">‚ö†Ô∏è Warning</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sla-breached" style="color: var(--danger);">0</div>
            <div class="stat-label">‚ùå Breached</div>
        </div>
    </div>

    <!-- SLA Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Device SLA Status</h3>
            <span class="status-badge" id="table-info">Loading...</span>
        </div>
        <div class="card-body" style="overflow-x: auto;">
            <table class="table" id="sla-table">
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th style="text-align: center;">Status</th>
                        <th style="text-align: right;">Uptime %</th>
                        <th style="text-align: center;">SLA Target</th>
                        <th style="text-align: center;">SLA Status</th>
                        <th style="text-align: right;">Checks</th>
                        <th style="text-align: right;">Avg Response</th>
                    </tr>
                </thead>
                <tbody id="sla-tbody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            Loading SLA data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- SLA Legend -->
    <div class="card mt-2">
        <div class="card-body" style="padding: 0.75rem;">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
                <span><span class="status-badge status-up">‚úÖ Met</span> Uptime ‚â• Target</span>
                <span><span class="status-badge status-slow">‚ö†Ô∏è Warning</span> Uptime within 1% of Target</span>
                <span><span class="status-badge status-down">‚ùå Breached</span> Uptime below Target</span>
                <span><span class="status-badge status-unknown">üìä No Data</span> Insufficient history</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SLA Dashboard Script -->
<script>
    // Load SLA data on page load
    document.addEventListener('DOMContentLoaded', loadSlaData);

    async function loadSlaData() {
        const days = document.getElementById('sla-period').value;
        const target = document.getElementById('sla-target').value;

        try {
            const response = await fetch(`/api/sla?days=${days}&target=${target}`);
            const data = await response.json();

            updateSummary(data.summary);
            updateTable(data.devices);
        } catch (error) {
            console.error('Error loading SLA data:', error);
            document.getElementById('sla-tbody').innerHTML = `
                    <tr><td colspan="9" style="text-align: center; color: var(--danger); padding: 2rem;">
                        Error loading SLA data
                    </td></tr>
                `;
        }
    }

    function updateSummary(summary) {
        document.getElementById('avg-uptime').textContent =
            summary.average_uptime ? summary.average_uptime.toFixed(2) + '%' : '-';
        document.getElementById('total-devices').textContent = summary.total_devices;
        document.getElementById('sla-met').textContent = summary.sla_met;
        document.getElementById('sla-warning').textContent = summary.sla_warning;
        document.getElementById('sla-breached').textContent = summary.sla_breached;

        // Update table info badge
        const tableInfo = document.getElementById('table-info');
        tableInfo.textContent = `${summary.days} days, Target: ${summary.sla_target}%`;
        tableInfo.className = 'status-badge status-up';
    }

    function updateTable(devices) {
        const tbody = document.getElementById('sla-tbody');

        if (!devices || devices.length === 0) {
            tbody.innerHTML = `
                    <tr><td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        No devices found
                    </td></tr>
                `;
            return;
        }

        // Sort by uptime (null values last, then by uptime ascending to show worst first)
        devices.sort((a, b) => {
            if (a.uptime_percent === null && b.uptime_percent === null) return 0;
            if (a.uptime_percent === null) return 1;
            if (b.uptime_percent === null) return -1;
            return a.uptime_percent - b.uptime_percent;
        });

        tbody.innerHTML = devices.map(device => {
            const statusClass = getStatusClass(device.current_status);
            const slaClass = getSlaClass(device.sla_status);
            const slaIcon = getSlaIcon(device.sla_status);
            const uptime = device.uptime_percent !== null
                ? device.uptime_percent.toFixed(4) + '%'
                : 'N/A';
            const uptimeColor = getUptimeColor(device.uptime_percent, device.sla_target);
            const avgResponse = device.avg_response_time !== null
                ? device.avg_response_time + ' ms'
                : 'N/A';

            return `
                    <tr>
                        <td>
                            <strong>${device.name}</strong><br>
                            <small style="color: var(--text-muted);">${device.ip_address}</small>
                        </td>
                        <td>${getDeviceTypeIcon(device.device_type)} ${device.device_type || '-'}</td>
                        <td>${device.location || '-'}</td>
                        <td style="text-align: center;">
                            <span class="status-badge ${statusClass}">${device.current_status || 'unknown'}</span>
                        </td>
                        <td style="text-align: right; font-weight: 600; color: ${uptimeColor};">
                            ${uptime}
                        </td>
                        <td style="text-align: center;">${device.sla_target}%</td>
                        <td style="text-align: center;">
                            <span class="status-badge ${slaClass}">${slaIcon}</span>
                        </td>
                        <td style="text-align: right;">${device.total_checks}</td>
                        <td style="text-align: right;">${avgResponse}</td>
                    </tr>
                `;
        }).join('');
    }

    function getStatusClass(status) {
        switch (status) {
            case 'up': return 'status-up';
            case 'down': return 'status-down';
            case 'slow': return 'status-slow';
            default: return 'status-unknown';
        }
    }

    function getSlaClass(status) {
        switch (status) {
            case 'met': return 'status-up';
            case 'warning': return 'status-slow';
            case 'breached': return 'status-down';
            default: return 'status-unknown';
        }
    }

    function getSlaIcon(status) {
        switch (status) {
            case 'met': return '‚úÖ Met';
            case 'warning': return '‚ö†Ô∏è Warning';
            case 'breached': return '‚ùå Breached';
            default: return 'üìä No Data';
        }
    }

    function getUptimeColor(uptime, target) {
        if (uptime === null) return 'var(--text-muted)';
        if (uptime >= target) return 'var(--success)';
        if (uptime >= target - 1) return 'var(--warning)';
        return 'var(--danger)';
    }

    function getDeviceTypeIcon(type) {
        const icons = {
            'server': 'üñ•Ô∏è',
            'router': 'üîÄ',
            'switch': 'üîå',
            'firewall': 'üõ°Ô∏è',
            'access_point': 'üì°',
            'wireless': 'üì∂',
            'website': 'üåê',
            'dns': 'üì¨',
            'cloud': '‚òÅÔ∏è',
            'other': 'üì¶'
        };
        return icons[type] || 'üì¶';
    }
</script>
{% endblock %}