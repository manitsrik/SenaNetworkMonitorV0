{% extends "layout.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Network Monitor - Main Status{% endblock %}

{% block page_title %}Main Status{% endblock %}

{% block header_actions %}
{% if session.role == 'admin' %}
<a href="/dashboard/1/edit" class="btn btn-xs btn-primary">
    <i class="fa-solid fa-pen-to-square"></i> Edit Dashboard
</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-container" style="padding-top: 0.25rem;">
    <div id="grid-canvas" class="grid-canvas">
        <!-- Dashboard content will be loaded dynamically -->
        <div
            style="display:flex; align-items:center; justify-content:center; height:300px; width:100%; grid-column: span 12;">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin fa-2x text-primary mb-3"></i>
                <p class="text-muted">Loading components...</p>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Input for logic -->
<input type="hidden" id="dashboard-id" value="1">
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Vis.js Network for Topology -->
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<!-- Shared Renderer Library -->
<script src="{{ url_for('static', filename='js/renderer_lib.js') }}?v=editable_main"></script>

<script>
    let currentDashboard = null;
    let currentData = { devices: [], stats: {}, connections: [] };

    document.addEventListener('DOMContentLoaded', async () => {
        const dashboardId = document.getElementById('dashboard-id').value;
        if (!dashboardId) return;

        try {
            // Load everything in parallel
            const [configResponse, devices, stats, topology] = await Promise.all([
                fetch(`/api/dashboards/${dashboardId}`),
                fetch('/api/devices').then(r => r.json()),
                fetch('/api/statistics').then(r => r.json()),
                fetch('/api/topology').then(r => r.json())
            ]);

            if (!configResponse.ok) throw new Error('Dashboard not found in database');
            currentDashboard = await configResponse.json();
            currentData = { devices, stats, connections: topology.connections };

            render();

            // Setup Socket.IO for live updates
            const socket = io();
            socket.on('status_update', () => loadData().then(render));
            socket.on('statistics_update', (stats) => {
                currentData.stats = stats;
                render();
            });
            socket.on('topology_updated', () => loadData().then(render));

        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('grid-canvas').innerHTML = `
                <div style="grid-column: span 12;" class="alert alert-danger">
                    <h4>Error loading Main Status dashboard</h4>
                    <p>${error.message}</p>
                    <p>Please ensure initialize_main_dashboard.py has been run.</p>
                </div>`;
        }
    });

    async function loadData() {
        try {
            const [devices, stats, topology] = await Promise.all([
                fetch('/api/devices').then(r => r.json()),
                fetch('/api/statistics').then(r => r.json()),
                fetch('/api/topology').then(r => r.json())
            ]);
            currentData = { devices, stats, connections: topology.connections };
        } catch (e) {
            console.error("Error fetching data:", e);
        }
    }

    function render() {
        if (!currentDashboard) return;
        const container = document.getElementById('grid-canvas');

        if (typeof DashboardRenderer === 'undefined') {
            setTimeout(render, 100);
            return;
        }

        try {
            DashboardRenderer.renderDashboard(container, currentDashboard.layout_config, currentData, false);
        } catch (e) {
            console.error('Error in renderDashboard:', e);
            container.innerHTML = `<div style="grid-column: span 12;" class="alert alert-danger">Error rendering dashboard: ${e.message}</div>`;
        }
    }
</script>
{% endblock %}